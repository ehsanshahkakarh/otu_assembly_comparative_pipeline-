# Merged Database Tables

This directory contains scripts and data for merging and analyzing taxonomic data from all sources (GTDB, NCBI, and Eukprot).

## Triple Anchor Merger Scripts

The following scripts perform comprehensive taxonomic merging using a triple-anchor strategy:

- `phylum_triple_anchor_merger.py` - Phylum-level merger
- `family_triple_anchor_merger.py` - Family-level merger
- `genus_triple_anchor_merger.py` - Genus-level merger

### Candidat Taxa Filter

All merger scripts include a configurable filter to exclude taxa starting with "candidat" (case-insensitive) from the output results. This filter can be easily toggled:

**To EXCLUDE candidat taxa from output:**
```python
EXCLUDE_CANDIDAT_TAXA = True
```

**To INCLUDE candidat taxa in output:**
```python
# EXCLUDE_CANDIDAT_TAXA = True  # Comment out this line
```

The filter is located at the top of each merger script and affects only the final output CSV files. All processing and matching logic remains intact - only the final results are filtered.

### Output Columns

Each merger script generates CSV files with the following columns:

- **Taxonomic Name**: `Phylum`, `Family`, or `Genus` depending on the script
- **GTDB_Domain**: Domain classification from GTDB
- **NCBI_Domain**: Domain classification from NCBI
- **Database_Presence**: `Both`, `GTDB_Only`, or `NCBI_Only`
- **Match_Status**: `Match` or `No_Match`
- **Anchor_Type**: Matching strategy used (`Name`, `Accession`, `Accession+Taxid`, etc.)
- **GTDB_Genome_Count**: Number of genomes in GTDB for this taxon
- **GTDB_Species_Count**: Number of species in GTDB for this taxon
- **NCBI_Genome_Count**: Number of genomes in NCBI for this taxon
- **NCBI_Species_Count**: Number of species in NCBI for this taxon

The genome and species counts are extracted directly from the respective `*_counts.csv` and `*_species_counts.csv` files generated by the parsing scripts.

### Usage

Run any merger script from the merged_tables directory:
```bash
python phylum_triple_anchor_merger.py
python family_triple_anchor_merger.py
python genus_triple_anchor_merger.py
```

Output files are automatically saved to:
- `merge_outputs/phylum_triple_anchor_output/`
- `merge_outputs/family_triple_anchor_output/`
- `merge_outputs/genus_triple_anchor_output/`

Log files are saved to the `logs/` directory.

## Ignored Phyla

The following phyla are not NCBI recognized phyla and are not used in any analysis:

BS750m-G25,Bacteria,,GTDB_Only,No_Match,None,1,0
GCA-001730085,Bacteria,,GTDB_Only,No_Match,None,2,0
JACIXR01,Bacteria,,GTDB_Only,No_Match,None,3,0
JAGOBX01,Bacteria,,GTDB_Only,No_Match,None,2,0
JAHJDO01,Bacteria,,GTDB_Only,No_Match,None,7,0
JAJRZV01,Bacteria,,GTDB_Only,No_Match,None,1,0
JALSQH01,Bacteria,,GTDB_Only,No_Match,None,2,0
JAMORN01,Bacteria,,GTDB_Only,No_Match,None,1,0
JAMOTN01,Bacteria,,GTDB_Only,No_Match,None,1,0
QNDG01,Bacteria,,GTDB_Only,No_Match,None,14,0
RBG-13-61-14,Bacteria,,GTDB_Only,No_Match,None,3,0
SM23-31,Bacteria,,GTDB_Only,No_Match,None,7,0
T1Sed10-126,Bacteria,,GTDB_Only,No_Match,None,2,0
UBP13,Bacteria,,GTDB_Only,No_Match,None,8,0
UBP15,Bacteria,,GTDB_Only,No_Match,None,9,0
UBP18,Bacteria,,GTDB_Only,No_Match,None,8,0
UBP4,Bacteria,,GTDB_Only,No_Match,None,3,0
UBP7,Bacteria,,GTDB_Only,No_Match,None,6,0

## Merger Logic and Strategies

### Overview

The database merger implements a sophisticated multi-strategy approach to merge taxonomic data from GTDB, NCBI, and EukProt databases. The merger uses a "triple anchor" strategy that attempts multiple matching approaches to maximize successful taxonomic alignments.

### Core Merger Strategies

#### 1. **Name-Based Matching (Primary Strategy)**
- **Direct Name Match**: Exact string matching between taxonomic names
- **Normalized Name Match**: Case-insensitive matching with whitespace normalization
- **Suffix Handling**: Ignores suffixes after underscores (e.g., `Bacillota_A` → `Bacillota`)
- **Candidatus Preservation**: Maintains Candidatus taxa without stripping prefixes

#### 2. **Accession-Based Matching (Secondary Strategy)**
- **Cross-Database Accession Lookup**: Uses genome accessions to find taxonomic matches
- **Accession Maps**: Leverages pre-built accession-to-taxonomy mappings
- **Multi-Level Resolution**: Attempts matching at species, genus, family, and phylum levels

#### 3. **Lineage-Based Matching (Tertiary Strategy)**
- **Taxonomic Hierarchy Traversal**: Uses full lineage information for matching
- **Last Lineage Taxid Grouping**: Groups entries by the most specific taxonomic identifier
- **Partial Lineage Matching**: Matches based on available lineage components

### Taxonomic Name Processing

#### Suffix Handling Logic
```python
# Example: Handle taxonomic suffixes
"Bacillota_A" → "Bacillota"  # Remove suffix for matching
"Bacillota_B" → "Bacillota"  # Merge with same base name
"Pseudomonadota_C" → "Pseudomonadota"  # Consistent suffix removal
```

#### Candidatus Taxa Handling
- **Preservation**: Candidatus taxa are preserved in their original form
- **No Stripping**: Unlike previous approaches, Candidatus prefixes are maintained
- **NCBI Compatibility**: Updated NCBI taxonomy scripts properly handle Candidatus taxa

#### Organellar Sequence Processing
- **Host Organism Inference**: Extracts host taxonomy from organellar sequences
- **Pattern Recognition**: Identifies chloroplast, mitochondria, plastid, and apicoplast sequences
- **Vectorized Processing**: Optimized batch processing for performance

### Merger Workflow

#### Phase 1: Data Loading and Preprocessing
1. **Load Source Data**: Read GTDB, NCBI, and EukProt taxonomic tables
2. **Normalize Names**: Apply consistent naming conventions
3. **Build Accession Maps**: Create cross-reference mappings
4. **Extract Lineages**: Parse taxonomic hierarchy information

#### Phase 2: Multi-Strategy Matching
1. **Primary Matching**: Direct name-based matching with suffix handling
2. **Secondary Matching**: Accession-based cross-database lookup
3. **Tertiary Matching**: Lineage-based hierarchical matching
4. **Conflict Resolution**: Handle cases where multiple strategies yield different results

#### Phase 3: Data Aggregation and Output
1. **Count Aggregation**: Sum OTU counts for merged entries
2. **Metadata Preservation**: Maintain lineage and taxonomic information
3. **Quality Assessment**: Track match success rates and anchor types
4. **Output Generation**: Create standardized CSV files with comprehensive metadata

### Count Aggregation Logic

#### OTU Count Prioritization
- **Primary Metric**: Number of distinct OTU clusters (otu_count)
- **Removed Metric**: Sequence abundance counts (size_count) - removed for simplicity
- **Aggregation Method**: Sum OTU counts when merging taxonomically equivalent entries

#### Example Count Merging
```python
# Before merging:
"Bacillota_A": otu_count=150
"Bacillota_B": otu_count=75
"Bacillota": otu_count=200

# After merging (suffix-based):
"Bacillota": otu_count=425  # 150 + 75 + 200
```

### Database-Specific Considerations

#### GTDB-Specific Processing
- **Modern Nomenclature**: Handles updated bacterial and archaeal taxonomy
- **Genome-Centric**: Focuses on genome-level taxonomic assignments
- **Species Clusters**: Processes GTDB species cluster information

#### NCBI-Specific Processing
- **Traditional Taxonomy**: Maintains classical taxonomic hierarchy
- **Taxid Integration**: Uses NCBI taxonomy IDs for precise matching
- **Lineage Validation**: Validates taxonomic assignments against NCBI taxonomy

#### EukProt-Specific Processing
- **Eukaryotic Focus**: Specialized handling for eukaryotic taxonomy
- **Protein-Based**: Incorporates protein-level taxonomic information
- **Cross-Reference**: Links to both GTDB and NCBI where applicable

### Quality Control and Validation

#### Match Quality Metrics
- **Match Success Rate**: Percentage of successful taxonomic matches
- **Anchor Type Distribution**: Breakdown of matching strategies used
- **Database Coverage**: Proportion of taxa found in each database
- **Conflict Resolution**: Handling of contradictory taxonomic assignments

#### Output Validation
- **Taxonomic Consistency**: Ensures hierarchical relationships are maintained
- **Count Validation**: Verifies that aggregated counts are reasonable
- **Lineage Integrity**: Checks that merged lineages are taxonomically valid
- **Duplicate Detection**: Identifies and resolves duplicate entries

### Performance Optimizations

#### Vectorized Processing
- **Batch Operations**: Process multiple entries simultaneously
- **Pandas Integration**: Leverage vectorized pandas operations
- **Memory Efficiency**: Optimize memory usage for large datasets

#### Caching Strategies
- **Accession Maps**: Pre-build and cache accession-to-taxonomy mappings
- **Lineage Lookups**: Cache frequently accessed lineage information
- **Name Normalization**: Cache normalized name transformations

### Error Handling and Logging

#### Comprehensive Logging
- **Processing Steps**: Log each major processing phase
- **Match Statistics**: Track and report matching success rates
- **Error Reporting**: Detailed error messages for debugging
- **Performance Metrics**: Processing time and throughput statistics

#### Unmapped Taxa Analysis
- **Pattern Recognition**: Identify common patterns in unmapped taxa
- **Failure Categorization**: Classify reasons for matching failures
- **Improvement Suggestions**: Provide recommendations for better matching

### Configuration Options

#### Candidatus Taxa Filter
```python
EXCLUDE_CANDIDAT_TAXA = True  # Exclude from final output
# EXCLUDE_CANDIDAT_TAXA = False  # Include in final output
```

#### Suffix Handling
```python
HANDLE_SUFFIXES = True  # Enable suffix-based merging
SUFFIX_PATTERNS = ['_A', '_B', '_C', '_D']  # Recognized suffixes
```

#### Matching Thresholds
```python
MIN_MATCH_CONFIDENCE = 0.8  # Minimum confidence for matches
MAX_LINEAGE_DISTANCE = 2    # Maximum taxonomic distance for lineage matching
```

This merger logic provides a robust, flexible, and comprehensive approach to integrating taxonomic data from multiple sources while maintaining data quality and taxonomic integrity.